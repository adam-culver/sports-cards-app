<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sports Cards Evaluation</title>

  <link rel="stylesheet" href="style.css" />

  <!-- Tabulator -->
  <link
    href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css"
    rel="stylesheet"
  />
  <script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="logo">üÉè</div>
        <div>
          <h1>Sports Cards Evaluation</h1>
          <p class="subtitle">Upload a card image, detect details, and estimate value ranges.</p>
        </div>
      </div>

      <div class="topbar-actions">
        <button id="exportCsvBtn" class="btn btn-secondary" disabled>Export CSV</button>
      </div>
    </header>

    <section class="card">
      <div class="controls">
        <div class="control-group">
          <label class="label">Upload</label>
          <div class="upload-row">
            <input type="file" id="imageInput" accept="image/*" />
            <button id="uploadBtn" class="btn btn-primary">Upload & Evaluate</button>
          </div>
          <p id="status" class="status"></p>
        </div>

        <div class="control-group">
          <label class="label">Search (all fields)</label>
          <input
            type="text"
            id="searchInput"
            class="input"
            placeholder="Search athlete, set, year, sport, team..."
          />
        </div>

        <div class="control-group">
          <label class="label">Filter any column</label>
          <div class="universal-filter">
            <select id="filterField" class="input"></select>
            <select id="filterType" class="input">
              <option value="like">contains</option>
              <option value="=">=</option>
              <option value="!=">not</option>
              <option value="<"><</option>
              <option value="<="><=</option>
              <option value=">">></option>
              <option value=">=">>=</option>
            </select>
            <input id="filterValue" class="input" placeholder='e.g. "Baseball", "2024", "Topps"' />
            <button id="applyFilterBtn" class="btn btn-secondary">Apply</button>
          </div>

          <div class="filter-actions-row">
            <button id="clearFiltersBtn" class="btn btn-ghost">Clear filters</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="section-head">
        <h2>Results</h2>
        <div class="hint" id="resultsHint">No results yet ‚Äî upload an image to start.</div>
      </div>

      <div id="cardsTable"></div>
    </section>

    <footer class="footer">
      <span>Tip: sort by clicking column headers. Use filters to narrow results.</span>
    </footer>
  </div>

  <script>
    // ---------------------------
    // Tabulator table
    // ---------------------------
    window.cardsTable = new Tabulator("#cardsTable", {
      layout: "fitColumns",
      height: "560px",
      placeholder: "Upload an image to see evaluated cards here.",
      pagination: "local",
      paginationSize: 25,
      paginationSizeSelector: [10, 25, 50, 100],
      movableColumns: true,
      resizableColumns: true,
      columns: [
        { title: "Sport", field: "sport", width: 120 },
        { title: "League", field: "league", width: 110 },
        { title: "Year", field: "year", hozAlign: "center", width: 90 },
        { title: "Card Set", field: "cardSet", minWidth: 240 },
        { title: "Athlete", field: "athlete", minWidth: 170 },
        { title: "Team", field: "team", minWidth: 140 },
        {
          title: "Low Price",
          field: "lowPrice",
          hozAlign: "right",
          formatter: (cell) => {
            const v = cell.getValue();
            if (v === "" || v == null) return "";
            const n = Number(v);
            if (Number.isNaN(n)) return v;
            return `$${n.toFixed(2)}`;
          },
          width: 130,
        },
        {
          title: "High Price",
          field: "highPrice",
          hozAlign: "right",
          formatter: (cell) => {
            const v = cell.getValue();
            if (v === "" || v == null) return "";
            const n = Number(v);
            if (Number.isNaN(n)) return v;
            return `$${n.toFixed(2)}`;
          },
          width: 130,
        },
        { title: "Quantity", field: "quantity", hozAlign: "center", width: 110 },
      ],
    });

    // ---------------------------
    // UI elements
    // ---------------------------
    const searchEl = document.getElementById("searchInput");
    const exportBtn = document.getElementById("exportCsvBtn");
    const hintEl = document.getElementById("resultsHint");
    const clearBtn = document.getElementById("clearFiltersBtn");

    const filterFieldEl = document.getElementById("filterField");
    const filterTypeEl = document.getElementById("filterType");
    const filterValueEl = document.getElementById("filterValue");
    const applyFilterBtn = document.getElementById("applyFilterBtn");

    // ---------------------------
    // Filter field dropdown options from columns
    // ---------------------------
    function populateFilterFields() {
      const defs = window.cardsTable.getColumns()
        .map(c => c.getDefinition())
        .filter(d => d.field && d.title);

      filterFieldEl.innerHTML = defs
        .map(d => `<option value="${d.field}">${d.title}</option>`)
        .join("");
    }
    populateFilterFields();

    // ---------------------------
    // Filter state (we manage these explicitly)
    // ---------------------------
    function clearAllTableFilters() {
      window.cardsTable.clearFilter(true);
    }

    function applySearchFilter() {
      const q = (searchEl.value || "").trim().toLowerCase();

      // Remove existing search filter by re-clearing all and re-adding needed filters.
      // We'll rebuild all filters from current UI state in applyAllFilters().
      return q;
    }

    function applyUniversalFilter(q) {
      const field = filterFieldEl.value;
      const type = filterTypeEl.value;
      const raw = (filterValueEl.value || "").trim();

      if (!raw) return null;

      // numeric coercion if possible and operator is numeric-ish
      let value = raw;
      if (["<", "<=", ">", ">=", "=", "!="].includes(type)) {
        const asNum = Number(raw);
        if (!Number.isNaN(asNum)) value = asNum;
      }

      return { field, type, raw, value };
    }

    // This is the single source of truth for filters.
    function applyAllFilters() {
      clearAllTableFilters();

      const q = applySearchFilter();
      const uni = applyUniversalFilter(q);

      // Search across all displayed fields
      if (q) {
        window.cardsTable.addFilter((data) => {
          const blob = [
            data.sport,
            data.league,
            data.year,
            data.cardSet,
            data.athlete,
            data.team,
            data.lowPrice,
            data.highPrice,
            data.quantity,
          ].join(" ").toLowerCase();
          return blob.includes(q);
        });
      }

      // Universal filter (any column)
      if (uni) {
        window.cardsTable.addFilter((data) => {
          const cell = data[uni.field];

          if (uni.type === "like") {
            return String(cell ?? "").toLowerCase().includes(String(uni.raw).toLowerCase());
          }

          const leftNum = Number(cell);
          const rightNum = Number(uni.value);
          const bothNumbers = !Number.isNaN(leftNum) && !Number.isNaN(rightNum);

          const left = bothNumbers ? leftNum : String(cell ?? "");
          const right = bothNumbers ? rightNum : String(uni.value ?? "");

          switch (uni.type) {
            case "=": return left === right;
            case "!=": return left !== right;
            case "<": return left < right;
            case "<=": return left <= right;
            case ">": return left > right;
            case ">=": return left >= right;
            default: return true;
          }
        });
      }

      const shown = window.cardsTable.getDataCount("active");
      const total = window.cardsTable.getDataCount();
      hintEl.textContent = total
        ? `${shown} result(s) shown.`
        : `No results yet ‚Äî upload an image to start.`;

      exportBtn.disabled = total === 0;
    }

    // Expose for script.js to call after setData()
    window.applyAllFilters = applyAllFilters;

    // UI events
    searchEl.addEventListener("input", applyAllFilters);
    applyFilterBtn.addEventListener("click", applyAllFilters);
    filterValueEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") applyAllFilters();
    });

    clearBtn.addEventListener("click", () => {
      searchEl.value = "";
      filterValueEl.value = "";
      filterTypeEl.value = "like";
      applyAllFilters();
    });

    exportBtn.addEventListener("click", () => {
      window.cardsTable.download("csv", "sports-cards-evaluation.csv");
    });

    // Initialize hint/export state
    applyAllFilters();
  </script>

  <script src="script.js?v=5"></script>
</body>
</html>
