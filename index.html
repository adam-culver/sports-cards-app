<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sports Cards Evaluation</title>

  <!-- Roboto -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style.css" />

  <!-- Favicon bundle (root) -->
  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

  <!-- Tabulator -->
  <link
    href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css"
    rel="stylesheet"
  />
  <script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div class="brand no-logo">
        <div>
          <h1>Sports Cards Evaluation</h1>
          <p class="subtitle">Upload a card image, detect details, and estimate value ranges.</p>
        </div>
      </div>

      <div class="topbar-actions">
        <button id="exportCsvBtn" class="btn btn-secondary" disabled>Export CSV</button>
      </div>
    </header>

    <section class="card">
      <div class="controls">
        <div class="control-group">
          <label class="label">Upload</label>
          <div class="upload-row">
            <input type="file" id="imageInput" accept="image/*" />
            <button id="uploadBtn" class="btn btn-primary">Upload & Evaluate</button>
          </div>
          <p id="status" class="status"></p>
        </div>

        <div class="control-group">
          <label class="label">Search (all fields)</label>
          <input
            type="text"
            id="searchInput"
            class="input"
            placeholder='Try: "1974 Dolphins" or "NBA Jordan"'
          />
        </div>

        <div class="control-group">
          <label class="label">Filters (add multiple)</label>

          <div class="universal-filter">
            <select id="filterField" class="input"></select>
            <select id="filterType" class="input">
              <option value="like">contains</option>
              <option value="=">=</option>
              <option value="!=">not</option>
              <option value="<"><</option>
              <option value="<="><=</option>
              <option value=">">></option>
              <option value=">=">>=</option>
            </select>
            <input id="filterValue" class="input" placeholder='e.g. "Dolphins", "1974", "Jordan"' />
            <button id="addFilterBtn" class="btn btn-secondary">Add</button>
          </div>

          <div class="chips-row">
            <div id="filterChips" class="chips"></div>
            <button id="clearFiltersBtn" class="btn btn-ghost">Clear all</button>
          </div>
        </div>
      </div>
    </section>

    <!-- extra padding between sections -->
    <div class="spacer"></div>

    <section class="card">
      <div class="section-head">
        <h2>Results</h2>
        <div class="hint" id="resultsHint">No results yet — upload an image to start.</div>
      </div>

      <div id="cardsTable"></div>
    </section>
  </div>

  <script>
    // -----------------------------------
    // Formatters
    // -----------------------------------
    function moneyFormatter(cell) {
      const v = cell.getValue();
      if (v === "" || v == null) return "";
      const n = Number(v);
      if (Number.isNaN(n)) return v;
      return `$${n.toFixed(2)}`;
    }

    function ellipsisFormatter(cell) {
      const v = cell.getValue();
      const text = v == null ? "" : String(v);
      return `<span class="cell-ellipsis" title="${text.replace(/"/g, "&quot;")}">${text}</span>`;
    }

    // -----------------------------------
    // Google Images button column
    // -----------------------------------
    function googleImagesQueryFromRow(d) {
      const parts = [
        d.year,
        d.cardSet,
        d.athlete,
        d.team,
        d.league,
        d.sport,
        "trading card",
      ].filter(Boolean);

      return encodeURIComponent(parts.join(" "));
    }

    // ---------------------------
    // Tabulator columns (single source of truth)
    // ---------------------------
    const TABLE_COLUMNS = [
      { title: "Athlete", field: "athlete", formatter: ellipsisFormatter, minWidth: 180, widthGrow: 3, responsive: 0 },
      { title: "Year", field: "year", hozAlign: "center", width: 90, sorter: "number", responsive: 0 },
      { title: "Low", field: "lowPrice", hozAlign: "right", width: 110, sorter: "number", formatter: moneyFormatter, responsive: 0 },
      { title: "High", field: "highPrice", hozAlign: "right", width: 110, sorter: "number", formatter: moneyFormatter, responsive: 0 },

      { title: "Team", field: "team", formatter: ellipsisFormatter, minWidth: 140, widthGrow: 2, responsive: 2 },
      { title: "Card Set", field: "cardSet", formatter: ellipsisFormatter, minWidth: 220, widthGrow: 4, responsive: 3 },

      { title: "Sport", field: "sport", width: 120, responsive: 4 },
      { title: "League", field: "league", width: 110, responsive: 5 },

      { title: "Qty", field: "quantity", hozAlign: "center", width: 80, sorter: "number", responsive: 6 },

      // ✅ NEW: Images button opens Google Images in new tab
      {
        title: "Images",
        field: "_images",
        headerSort: false,
        hozAlign: "center",
        width: 56,
        formatter: () => `
  <button
    class="icon-btn"
    type="button"
    title="Search Google Images"
    aria-label="Search Google Images"
  >
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
      <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/>
      <line x1="16.65" y1="16.65" x2="21" y2="21"
            stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>
`,
        cellClick: (e, cell) => {
          const d = cell.getRow().getData();
          const q = googleImagesQueryFromRow(d);
          const url = `https://www.google.com/search?tbm=isch&q=${q}`;
          window.open(url, "_blank", "noopener,noreferrer");
        },
      },
    ];

    // ---------------------------
    // Tabulator table
    // ---------------------------
    window.cardsTable = new Tabulator("#cardsTable", {
      layout: "fitColumns",
      responsiveLayout: "collapse",
      responsiveLayoutCollapseStartOpen: false,

      height: "560px",
      placeholder: "Upload an image to see evaluated cards here.",

      pagination: "local",
      paginationSize: 100,
      paginationSizeSelector: [10, 25, 50, 100, 250],

      movableColumns: true,
      resizableColumns: true,

      columns: TABLE_COLUMNS,
    });

    // ---------------------------
    // UI elements
    // ---------------------------
    const searchEl = document.getElementById("searchInput");
    const exportBtn = document.getElementById("exportCsvBtn");
    const hintEl = document.getElementById("resultsHint");

    const filterFieldEl = document.getElementById("filterField");
    const filterTypeEl = document.getElementById("filterType");
    const filterValueEl = document.getElementById("filterValue");
    const addFilterBtn = document.getElementById("addFilterBtn");
    const chipsEl = document.getElementById("filterChips");
    const clearAllBtn = document.getElementById("clearFiltersBtn");

    // ---------------------------
    // Filter chips state
    // ---------------------------
    let chipFilters = []; // {id, field, title, type, raw, value}

    function uid() {
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function populateFilterFields() {
      // ✅ Use the same columns we passed to Tabulator
      const defs = TABLE_COLUMNS.filter(d => d.field && d.title && !String(d.field).startsWith("_"));
      filterFieldEl.innerHTML = defs
        .map(d => `<option value="${d.field}">${d.title}</option>`)
        .join("");
    }
    populateFilterFields();

    function operatorLabel(type) {
      switch(type){
        case "like": return "contains";
        case "=": return "=";
        case "!=": return "≠";
        case "<": return "<";
        case "<=": return "≤";
        case ">": return ">";
        case ">=": return "≥";
        default: return type;
      }
    }

    function renderChips() {
      chipsEl.innerHTML = "";
      chipFilters.forEach(f => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "chip";
        chip.title = "Click to remove";
        chip.innerHTML = `
          <span class="chip-text">${f.title} ${operatorLabel(f.type)} "${f.raw}"</span>
          <span class="chip-x">×</span>
        `;
        chip.addEventListener("click", () => {
          chipFilters = chipFilters.filter(x => x.id !== f.id);
          renderChips();
          applyAllFilters();
        });
        chipsEl.appendChild(chip);
      });
    }

    function buildFilterFromUI() {
      const field = filterFieldEl.value;
      const title = filterFieldEl.options[filterFieldEl.selectedIndex]?.text || field;
      const type = filterTypeEl.value;
      const raw = (filterValueEl.value || "").trim();
      if (!raw) return null;

      let value = raw;
      if (["<", "<=", ">", ">=", "=", "!="].includes(type)) {
        const asNum = Number(raw);
        if (!Number.isNaN(asNum)) value = asNum;
      }
      return { id: uid(), field, title, type, raw, value };
    }

    // Add chip
    addFilterBtn.addEventListener("click", () => {
      const f = buildFilterFromUI();
      if (!f) return;

      chipFilters.push(f);
      filterValueEl.value = "";
      renderChips();
      applyAllFilters();
      filterValueEl.focus();
    });

    // Enter to add chip
    filterValueEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addFilterBtn.click();
    });

    // Clear all filters
    clearAllBtn.addEventListener("click", () => {
      searchEl.value = "";
      filterValueEl.value = "";
      filterTypeEl.value = "like";
      chipFilters = [];
      renderChips();
      applyAllFilters();
    });

    // Export
    exportBtn.addEventListener("click", () => {
      window.cardsTable.download("csv", "sports-cards-evaluation.csv");
    });

    // ---------------------------
    // Filter application (single source of truth)
    // ---------------------------
    function applyAllFilters() {
      window.cardsTable.clearFilter(true);

      const q = (searchEl.value || "").trim().toLowerCase();

      // Global search across all fields
      if (q) {
        window.cardsTable.addFilter((data) => {
          const blob = [
            data.sport, data.league, data.year,
            data.cardSet, data.athlete, data.team,
            data.lowPrice, data.highPrice, data.quantity
          ].join(" ").toLowerCase();
          return blob.includes(q);
        });
      }

      // AND all chip filters
      chipFilters.forEach(f => {
        window.cardsTable.addFilter((data) => {
          const cell = data[f.field];

          if (f.type === "like") {
            return String(cell ?? "").toLowerCase().includes(String(f.raw).toLowerCase());
          }

          const leftNum = Number(cell);
          const rightNum = Number(f.value);
          const bothNumbers = !Number.isNaN(leftNum) && !Number.isNaN(rightNum);

          const left = bothNumbers ? leftNum : String(cell ?? "");
          const right = bothNumbers ? rightNum : String(f.value ?? "");

          switch (f.type) {
            case "=": return left === right;
            case "!=": return left !== right;
            case "<": return left < right;
            case "<=": return left <= right;
            case ">": return left > right;
            case ">=": return left >= right;
            default: return true;
          }
        });
      });

      const shown = window.cardsTable.getDataCount("active");
      const total = window.cardsTable.getDataCount();

      hintEl.textContent = total
        ? `${shown} result(s) shown.`
        : `No results yet — upload an image to start.`;

      exportBtn.disabled = total === 0;
    }

    // Expose so script.js can call after setData()
    window.applyAllFilters = applyAllFilters;

    // Keep search live
    searchEl.addEventListener("input", applyAllFilters);

    // Initial
    renderChips();
    applyAllFilters();
  </script>
// ---------------------------
// Mobile: make table height fit viewport to avoid scroll fighting
// ---------------------------
function setTableHeightForViewport() {
  if (!window.cardsTable) return;

  // only apply on phones
  const isMobile = window.matchMedia("(max-width: 720px)").matches;
  if (!isMobile) {
    // restore desktop-friendly height
    window.cardsTable.setHeight("560px");
    return;
  }

  const tableEl = document.getElementById("cardsTable");
  if (!tableEl) return;

  // distance from top of viewport to the table
  const rect = tableEl.getBoundingClientRect();
  const top = rect.top;

  // leave a little space for bottom padding / iOS browser chrome
  const buffer = 18;

  // choose a minimum so it never collapses too small
  const min = 260;

  const available = Math.max(min, Math.floor(window.innerHeight - top - buffer));
  window.cardsTable.setHeight(available + "px");
}

window.addEventListener("resize", setTableHeightForViewport);
window.addEventListener("orientationchange", setTableHeightForViewport);
setTimeout(setTableHeightForViewport, 0);

// Also run after data loads (script.js calls applyAllFilters; we can hook here)
const _applyAll = window.applyAllFilters;
window.applyAllFilters = function() {
  if (typeof _applyAll === "function") _applyAll();
  setTableHeightForViewport();
};

  <script src="script.js?v=7"></script>
</body>
</html>
