<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sports Cards Tracker</title>

  <link rel="stylesheet" href="style.css" />

  <!-- Tabulator (flexible table component) -->
  <link
    href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css"
    rel="stylesheet"
  />
  <script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
</head>

<body>
  <div class="app">
    <!-- Header -->
    <header class="topbar">
      <div class="brand">
        <div class="logo">üÉè</div>
        <div>
          <h1>Sports Cards Evaluation</h1>
          <p class="subtitle">Upload a card image, detect details, and estimate value ranges.</p>
        </div>
      </div>

      <div class="topbar-actions">
        <button id="exportCsvBtn" class="btn btn-secondary" disabled>Export CSV</button>
      </div>
    </header>

    <!-- Upload / Controls -->
    <section class="card">
      <div class="controls">
        <div class="control-group">
          <label class="label">Upload</label>
          <div class="upload-row">
            <input type="file" id="imageInput" accept="image/*" />
            <button id="uploadBtn" class="btn btn-primary">Upload & Evaluate</button>
          </div>
          <p id="status" class="status"></p>
        </div>

        <div class="control-group">
          <label class="label">Search</label>
          <input type="text" id="searchInput" class="input" placeholder="Search athlete, set, year, sport..." />
        </div>

        <div class="control-group filters">
          <div>
            <label class="label">Sport</label>
            <select id="sportFilter" class="input">
              <option value="">All</option>
            </select>
          </div>
          <div>
            <label class="label">Year</label>
            <select id="yearFilter" class="input">
              <option value="">All</option>
            </select>
          </div>
          <div class="filter-actions">
            <button id="clearFiltersBtn" class="btn btn-ghost">Clear filters</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section class="card">
      <div class="section-head">
        <h2>Results</h2>
        <div class="hint" id="resultsHint">No results yet ‚Äî upload an image to start.</div>
      </div>

      <!-- Tabulator mounts here (REPLACES <table>) -->
      <div id="cardsTable"></div>
    </section>

    <footer class="footer">
      <span>Tip: you can sort by clicking column headers.</span>
    </footer>
  </div>

  <!-- Expose config for script.js (so script.js can stay clean) -->
  <script>
    // Create Tabulator table instance. script.js can call:
    //   window.cardsTable.setData(rows)
    //   window.cardsTable.getData()
    //   window.refreshFilterOptions(rows)
    // and it will just work.
    window.cardsTable = new Tabulator("#cardsTable", {
      layout: "fitColumns",
      height: "560px",
      placeholder: "Upload an image to see evaluated cards here.",
      pagination: "local",
      paginationSize: 25,
      paginationSizeSelector: [10, 25, 50, 100],
      movableColumns: true,
      resizableColumns: true,
      columns: columns: [
  { title: "Sport", field: "sport", width: 120 },
  { title: "League", field: "league", width: 110 },
  { title: "Year", field: "year", hozAlign: "center", width: 90 },
  { title: "Card Set", field: "cardSet", minWidth: 240 },
  { title: "Athlete", field: "athlete", minWidth: 170 },
  { title: "Team", field: "team", minWidth: 140 },
  {
    title: "Low Price",
    field: "lowPrice",
    hozAlign: "right",
    formatter: "money",
    formatterParams: { symbol: "$", precision: 2 },
    width: 130,
  },
  {
    title: "High Price",
    field: "highPrice",
    hozAlign: "right",
    formatter: "money",
    formatterParams: { symbol: "$", precision: 2 },
    width: 130,
  },
  { title: "Quantity", field: "quantity", hozAlign: "center", width: 110 },
],
,
    });

    // Filter dropdowns are populated based on current data
    window.refreshFilterOptions = function(rows) {
      const sportEl = document.getElementById("sportFilter");
      const yearEl = document.getElementById("yearFilter");

      const sports = [...new Set((rows || []).map(r => r.sport).filter(Boolean))].sort();
      const years = [...new Set((rows || []).map(r => r.year).filter(Boolean))].sort((a,b)=>a-b);

      // Preserve current selection if possible
      const currentSport = sportEl.value;
      const currentYear = yearEl.value;

      sportEl.innerHTML = `<option value="">All</option>` + sports.map(s => `<option value="${s}">${s}</option>`).join("");
      yearEl.innerHTML = `<option value="">All</option>` + years.map(y => `<option value="${y}">${y}</option>`).join("");

      if (sports.includes(currentSport)) sportEl.value = currentSport;
      if (years.map(String).includes(String(currentYear))) yearEl.value = currentYear;
    };

    // Wiring up UI filters to Tabulator
    const searchEl = document.getElementById("searchInput");
    const sportEl = document.getElementById("sportFilter");
    const yearEl = document.getElementById("yearFilter");
    const clearBtn = document.getElementById("clearFiltersBtn");
    const exportBtn = document.getElementById("exportCsvBtn");
    const hintEl = document.getElementById("resultsHint");

    function applyFilters() {
      const q = (searchEl.value || "").toLowerCase().trim();
      const sport = sportEl.value;
      const year = yearEl.value;

      window.cardsTable.clearFilter(true);

      // Text search across multiple fields
      if (q) {
        window.cardsTable.addFilter((data) => {
          const blob = [
            data.cardType,
            data.athlete,
            data.sport,
            data.year,
            data.source,
          ].join(" ").toLowerCase();
          return blob.includes(q);
        });
      }

      if (sport) window.cardsTable.addFilter("sport", "=", sport);
      if (year) window.cardsTable.addFilter("year", "=", Number(year));

      const count = window.cardsTable.getDataCount("active");
      hintEl.textContent = count ? `${count} result(s) shown.` : `No matches‚Äîtry clearing filters.`;

      // Enable export only if there is data
      exportBtn.disabled = window.cardsTable.getDataCount() === 0;
    }

    searchEl.addEventListener("input", applyFilters);
    sportEl.addEventListener("change", applyFilters);
    yearEl.addEventListener("change", applyFilters);

    clearBtn.addEventListener("click", () => {
      searchEl.value = "";
      sportEl.value = "";
      yearEl.value = "";
      applyFilters();
    });

    exportBtn.addEventListener("click", () => {
      window.cardsTable.download("csv", "sports-cards-evaluation.csv");
    });

    // Helpful hook: when script.js sets data, it should also call applyFilters().
    window.applyFilters = applyFilters;
  </script>

  <script src="script.js?v=4"></script>
</body>
</html>
