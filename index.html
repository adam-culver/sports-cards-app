<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sports Cards Evaluation</title>

  <!-- Roboto -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style.css" />

  <!-- Favicons -->
  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">

  <!-- Tabulator -->
  <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div>
          <h1>Sports Cards Evaluation</h1>
          <p class="subtitle">Upload a card image, detect details, and estimate value ranges.</p>
        </div>
      </div>
      <button id="exportCsvBtn" class="btn btn-secondary" disabled>Export CSV</button>
    </header>

    <section class="card">
      <div class="controls">
        <div>
          <label class="label">Upload</label>
          <div class="upload-row">
            <input type="file" id="imageInput" accept="image/*">
            <button id="uploadBtn" class="btn btn-primary">Upload & Evaluate</button>
          </div>
          <p id="status" class="status"></p>
        </div>

        <div>
          <label class="label">Search (all fields)</label>
          <input id="searchInput" class="input" placeholder='Try: "1974 Dolphins" or "NBA Jordan"'>
        </div>

        <div>
          <label class="label">Filters (add multiple)</label>
          <div class="filter-row">
            <select id="filterField" class="input"></select>
            <select id="filterType" class="input">
              <option value="like">contains</option>
              <option value="=">=</option>
              <option value="!=">not</option>
            </select>
            <input id="filterValue" class="input" placeholder='e.g. "Jordan"'>
            <button id="addFilterBtn" class="btn btn-secondary">Add</button>
          </div>
          <div class="chips-row">
            <div id="filterChips" class="chips"></div>
            <button id="clearFiltersBtn" class="btn btn-ghost">Clear all</button>
          </div>
        </div>
      </div>
    </section>

    <div class="spacer"></div>

    <section class="card">
      <div class="section-head">
        <h2>Results</h2>
        <span id="resultsHint" class="hint">No results yet — upload an image to start.</span>
      </div>
      <div id="cardsTable"></div>
    </section>

    <footer class="footer">
      Tip: sort columns or use multiple filters for precision.
    </footer>
  </div>

<script>
/* ---------------- TABLE ---------------- */
function ellipsis(cell){
  const v = cell.getValue() ?? "";
  return `<span class="ellipsis" title="${v}">${v}</span>`;
}
function money(cell){
  const v = Number(cell.getValue());
  return isNaN(v) ? "" : `$${v.toFixed(2)}`;
}

window.cardsTable = new Tabulator("#cardsTable",{
  layout:"fitColumns",
  responsiveLayout:"collapse",
  height:"560px",
  pagination:"local",
  paginationSize:100,
  paginationSizeSelector:[25,50,100,250],

  columns:[
    {title:"Athlete", field:"athlete", widthGrow:3, minWidth:160, responsive:0, formatter:ellipsis},
    {title:"Year", field:"year", width:90, hozAlign:"center", responsive:0},
    {title:"Low", field:"lowPrice", width:110, hozAlign:"right", responsive:0, formatter:money},
    {title:"High", field:"highPrice", width:110, hozAlign:"right", responsive:0, formatter:money},

    {title:"Team", field:"team", widthGrow:2, minWidth:140, responsive:2, formatter:ellipsis},
    {title:"Card Set", field:"cardSet", widthGrow:4, minWidth:220, responsive:3, formatter:ellipsis},
    {title:"Sport", field:"sport", width:110, responsive:4},
    {title:"League", field:"league", width:100, responsive:5},
    {title:"Qty", field:"quantity", width:80, hozAlign:"center", responsive:6},
  ],
});

/* ---------------- FILTERING ---------------- */
const search = document.getElementById("searchInput");
const fieldSel = document.getElementById("filterField");
const typeSel = document.getElementById("filterType");
const valueInput = document.getElementById("filterValue");
const addBtn = document.getElementById("addFilterBtn");
const chips = document.getElementById("filterChips");
const clearBtn = document.getElementById("clearFiltersBtn");
const hint = document.getElementById("resultsHint");

let chipFilters=[];

function populateFields(){
  fieldSel.innerHTML = cardsTable.getColumns()
    .map(c=>c.getDefinition())
    .filter(d=>d.field)
    .map(d=>`<option value="${d.field}">${d.title}</option>`)
    .join("");
}
populateFields();

function applyFilters(){
  cardsTable.clearFilter(true);

  if(search.value){
    const q=search.value.toLowerCase();
    cardsTable.addFilter(r=>Object.values(r).join(" ").toLowerCase().includes(q));
  }

  chipFilters.forEach(f=>{
    cardsTable.addFilter(r=>{
      const v = String(r[f.field]??"").toLowerCase();
      return f.type==="like"
        ? v.includes(f.value)
        : f.type==="=" ? v===f.value : v!==f.value;
    });
  });

  const shown=cardsTable.getDataCount("active");
  hint.textContent=shown?`${shown} result(s) shown.`:`No results yet — upload an image to start.`;
}

search.oninput=applyFilters;

addBtn.onclick=()=>{
  if(!valueInput.value) return;
  chipFilters.push({
    field:fieldSel.value,
    type:typeSel.value,
    value:valueInput.value.toLowerCase()
  });
  valueInput.value="";
  renderChips();
  applyFilters();
};

function renderChips(){
  chips.innerHTML="";
  chipFilters.forEach((f,i)=>{
    const b=document.createElement("button");
    b.className="chip";
    b.textContent=`${fieldSel.querySelector(`[value="${f.field}"]`).text} ${f.type} "${f.value}" ×`;
    b.onclick=()=>{chipFilters.splice(i,1);renderChips();applyFilters();};
    chips.appendChild(b);
  });
}

clearBtn.onclick=()=>{
  chipFilters=[];
  search.value="";
  renderChips();
  applyFilters();
};

window.applyAllFilters=applyFilters;
</script>

<script src="script.js"></script>
</body>
</html>
